name: Android Build

on:
  push:
    branches: [ master, develop ]
    paths:
      - 'android/**'
      - 'core/**'
      - 'adapters/android/**'
      - '.github/workflows/android-build.yml'
  pull_request:
    branches: [ master, develop ]
    paths:
      - 'android/**'
      - 'core/**'
      - 'adapters/android/**'
  workflow_dispatch:

jobs:
  build:
    name: Build Android
    runs-on: ubuntu-latest

    strategy:
      matrix:
        build-type: [debug, release]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Setup Android SDK
      uses: android-actions/setup-android@v3

    - name: Install NDK
      run: |
        sdkmanager --install "ndk;26.1.10909125" "cmake;3.22.1"

    - name: Cache Gradle dependencies
      uses: actions/cache@v3
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-

    - name: Cache FFTW3 build
      id: cache-fftw3
      uses: actions/cache@v3
      with:
        path: android/libs/fftw3
        key: ${{ runner.os }}-fftw3-3.3.10-ndk26

    - name: Build FFTW3
      if: steps.cache-fftw3.outputs.cache-hit != 'true'
      run: |
        export ANDROID_NDK_ROOT=$ANDROID_HOME/ndk/26.1.10909125
        cd android
        ./build-fftw3.sh

    - name: Grant execute permission for gradlew
      run: chmod +x android/gradlew

    - name: Build with Gradle
      working-directory: android
      run: |
        if [ "${{ matrix.build-type }}" == "release" ]; then
          ./gradlew assembleRelease bundleRelease
        else
          ./gradlew assembleDebug
        fi

    - name: Run tests
      working-directory: android
      run: ./gradlew test

    - name: Upload APK
      uses: actions/upload-artifact@v3
      with:
        name: js8call-${{ matrix.build-type }}-apk
        path: android/app/build/outputs/apk/${{ matrix.build-type }}/*.apk

    - name: Upload AAR
      if: matrix.build-type == 'release'
      uses: actions/upload-artifact@v3
      with:
        name: js8call-core-aar
        path: android/js8core-lib/build/outputs/aar/*.aar

    - name: Upload AAB (Release only)
      if: matrix.build-type == 'release'
      uses: actions/upload-artifact@v3
      with:
        name: js8call-release-aab
        path: android/app/build/outputs/bundle/release/*.aab

  lint:
    name: Lint
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Grant execute permission for gradlew
      run: chmod +x android/gradlew

    - name: Run lint
      working-directory: android
      run: ./gradlew lint

    - name: Upload lint results
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: lint-results
        path: android/*/build/reports/lint-results*.html
