name: Android Build

on:
  push:
    branches: [ master, develop ]
    paths:
      - 'android/**'
      - 'core/**'
      - 'adapters/android/**'
      - '.github/workflows/android-build.yml'
  pull_request:
    branches: [ master, develop ]
    paths:
      - 'android/**'
      - 'core/**'
      - 'adapters/android/**'
  workflow_dispatch:
    inputs:
      build_type:
        description: Build type
        required: false
        default: debug
        type: choice
        options:
          - debug
          - release
          - both

env:
  BOOST_VERSION: 1.83.0
  BOOST_VERSION_UNDERSCORE: 1_83_0
  HAMLIB_VERSION: master
  ANDROID_NDK_VERSION: 26.1.10909125

jobs:
  build:
    name: Build Android
    runs-on: ubuntu-latest

    strategy:
      matrix:
        build-type: ${{ fromJSON(github.event_name == 'workflow_dispatch' && (github.event.inputs.build_type == 'both' && '["debug","release"]' || format('["{0}"]', github.event.inputs.build_type)) || '["debug"]') }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Setup Android SDK
      uses: android-actions/setup-android@v3

    - name: Install NDK
      run: |
        sdkmanager --install "ndk;${ANDROID_NDK_VERSION}" "cmake;3.22.1"

    - name: Select NDK
      run: |
        echo "ANDROID_NDK_HOME=${ANDROID_HOME}/ndk/${ANDROID_NDK_VERSION}" >> "$GITHUB_ENV"
        echo "ANDROID_NDK_ROOT=${ANDROID_HOME}/ndk/${ANDROID_NDK_VERSION}" >> "$GITHUB_ENV"

    - name: Install Hamlib build dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y autoconf automake libtool pkg-config

    - name: Cache Hamlib build
      id: cache-hamlib
      uses: actions/cache@v4
      with:
        path: |
          android/hamlib/hamlib-src
          android/libs/hamlib
        key: ${{ runner.os }}-hamlib-${{ env.HAMLIB_VERSION }}-ndk-${{ env.ANDROID_NDK_VERSION }}-${{ hashFiles('android/hamlib/patches/*.patch', 'android/hamlib/build-hamlib-android.sh') }}

    - name: Build Hamlib
      if: steps.cache-hamlib.outputs.cache-hit != 'true'
      run: |
        export ANDROID_NDK_ROOT=$ANDROID_NDK_ROOT
        export ANDROID_NDK_HOME=$ANDROID_NDK_HOME
        export HAMLIB_VERSION=${HAMLIB_VERSION}
        ./android/hamlib/build-hamlib-android.sh

    - name: Cache Boost headers
      id: cache-boost
      uses: actions/cache@v4
      with:
        path: .deps/boost
        key: ${{ runner.os }}-boost-${{ env.BOOST_VERSION_UNDERSCORE }}

    - name: Download Boost headers
      if: steps.cache-boost.outputs.cache-hit != 'true'
      run: |
        mkdir -p .deps/boost
        curl -L -o /tmp/boost.tar.gz \
          https://archives.boost.io/release/${BOOST_VERSION}/source/boost_${BOOST_VERSION_UNDERSCORE}.tar.gz
        tar -xzf /tmp/boost.tar.gz -C .deps/boost

    - name: Set Boost include path
      run: |
        BOOST_DIR="${GITHUB_WORKSPACE}/.deps/boost/boost_${BOOST_VERSION_UNDERSCORE}"
        echo "BOOST_ROOT=${BOOST_DIR}" >> "$GITHUB_ENV"
        echo "BOOST_INCLUDEDIR=${BOOST_DIR}" >> "$GITHUB_ENV"

    - name: Cache Gradle dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-

    - name: Cache FFTW3 build
      id: cache-fftw3
      uses: actions/cache@v4
      with:
        path: android/libs/fftw3
        key: ${{ runner.os }}-fftw3-3.3.10-ndk-${{ env.ANDROID_NDK_VERSION }}

    - name: Build FFTW3
      if: steps.cache-fftw3.outputs.cache-hit != 'true'
      run: |
        export ANDROID_NDK_ROOT=$ANDROID_NDK_ROOT
        cd android
        ./build-fftw3.sh

    - name: Grant execute permission for gradlew
      run: chmod +x android/gradlew

    - name: Prepare release keystore
      if: matrix.build-type == 'release'
      run: |
        if [ -z "${{ secrets.JS8_KEYSTORE_BASE64 }}" ]; then
          echo "Missing JS8_KEYSTORE_BASE64 secret"
          exit 1
        fi
        echo "${{ secrets.JS8_KEYSTORE_BASE64 }}" | base64 -d > android/release.jks

    - name: Configure release signing env
      if: matrix.build-type == 'release'
      run: |
        echo "JS8_KEYSTORE_FILE=release.jks" >> "$GITHUB_ENV"
        echo "JS8_KEYSTORE_PASSWORD=${{ secrets.JS8_KEYSTORE_PASSWORD }}" >> "$GITHUB_ENV"
        echo "JS8_KEY_ALIAS=${{ secrets.JS8_KEY_ALIAS }}" >> "$GITHUB_ENV"
        echo "JS8_KEY_PASSWORD=${{ secrets.JS8_KEY_PASSWORD }}" >> "$GITHUB_ENV"

    - name: Build with Gradle
      working-directory: android
      run: |
        if [ "${{ matrix.build-type }}" == "release" ]; then
          ./gradlew assembleRelease bundleRelease
        else
          ./gradlew assembleDebug
        fi

    - name: Run tests
      working-directory: android
      run: ./gradlew test

    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: js8call-${{ matrix.build-type }}-apk
        path: android/app/build/outputs/apk/${{ matrix.build-type }}/*.apk

    - name: Upload AAR
      if: matrix.build-type == 'release'
      uses: actions/upload-artifact@v4
      with:
        name: js8call-core-aar
        path: android/js8core-lib/build/outputs/aar/*.aar

    - name: Upload AAB (Release only)
      if: matrix.build-type == 'release'
      uses: actions/upload-artifact@v4
      with:
        name: js8call-release-aab
        path: android/app/build/outputs/bundle/release/*.aab

#  lint:
#    name: Lint
#    runs-on: ubuntu-latest
#
#    steps:
#    - name: Checkout code
#      uses: actions/checkout@v4
#
#    - name: Cache Boost headers
#      id: cache-boost
#      uses: actions/cache@v4
#      with:
#        path: .deps/boost
#        key: ${{ runner.os }}-boost-${{ env.BOOST_VERSION_UNDERSCORE }}
#
#    - name: Download Boost headers
#      if: steps.cache-boost.outputs.cache-hit != 'true'
#      run: |
#        mkdir -p .deps/boost
#        curl -L -o /tmp/boost.tar.gz \
#          https://archives.boost.io/release/${BOOST_VERSION}/source/boost_${BOOST_VERSION_UNDERSCORE}.tar.gz
#        tar -xzf /tmp/boost.tar.gz -C .deps/boost
#
#    - name: Set Boost include path
#      run: |
#        BOOST_DIR="${GITHUB_WORKSPACE}/.deps/boost/boost_${BOOST_VERSION_UNDERSCORE}"
#        echo "BOOST_ROOT=${BOOST_DIR}" >> "$GITHUB_ENV"
#        echo "BOOST_INCLUDEDIR=${BOOST_DIR}" >> "$GITHUB_ENV"
#
#    - name: Set up JDK 17
#      uses: actions/setup-java@v4
#      with:
#        java-version: '17'
#        distribution: 'temurin'
#
#    - name: Grant execute permission for gradlew
#      run: chmod +x android/gradlew
#
#    - name: Run lint
#      working-directory: android
#      run: ./gradlew lint
#
#    - name: Upload lint results
#      uses: actions/upload-artifact@v4
#      if: always()
#      with:
#        name: lint-results
#        path: android/*/build/reports/lint-results*.html
